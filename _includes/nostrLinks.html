<h2>Projects</h2>

<div id="toggles" class="tags"></div>

<div id="results">
  {%- for p in site.pages -%}
    {%- if p.tags -%}
      {%- if p.github -%}
        {%- assign url = p.github | prepend: "https://github.com/" -%}
      {%- else -%}
        {%- assign url = p.web -%}
      {%- endif -%}
      <div class="result {{ p.tags | join: " " }} {{ p.platforms | join: " " }} {{ p.nips | join: " " }}">
        <div class="name"><a href="{{ url }}">{{ p.title }}</a></div>
        <div class="details"></div>
        <div class="tags">
          {%- for t in p.platforms -%}{% include tag.html tag=t type="platform" %}{%- endfor -%}
          {%- for t in p.tags -%}{% include tag.html tag=t type="tag" %}{%- endfor -%}
          {%- for t in p.nips -%}{% include tag.html tag=t type="nip" %}{%- endfor -%}
        </div>
        <div class="instances"><ul>{%- for i in p.instances -%}
                <li><a href="{{ i.url | default: i }}">{{ i.name | default: i }}</a>{%- if i.comment -%}: {{ i.comment }}{%- endif -%}</li>
                {%- endfor -%}</ul></div>
        <div class="gh">{%- if p.github -%}<img src="https://img.shields.io/github/stars/{{ p.github }}.svg?style=social" alt="stars">{%- endif -%}</div>
        <div class="details">{%- if p.content.size > 20 -%}<a href="{{ p.permalink }}">üîç</a>{%- endif -%}</div>
      </div>
    {%- endif -%}
  {%- endfor -%}
</div>

<script src="/js/stuff.js"></script>
<script>
window.addEventListener("load", update)
const toggles = document.getElementById("toggles")

function clickTag(t) {
  if (window.activeTags.includes(t)) {
    window.activeTags.splice(window.activeTags.indexOf(t), 1)
  } else {
    window.activeTags.push(t)
  }
  console.log(window.activeTags)
  update()
}

function updateAvailableTags() {
  if (window.activeTags.length) {
    window.availableTags = []
    function addFrom(name) {
      window.availableTags.push(
        ...new Set(
          window.stuff.filter(st => {
            const t = (st.tags || [])
              .concat(st.platforms || [])
              .concat(st.nips || [])
            return window
              .activeTags
              .every( it => t.includes(it) )
          })
          .map(it => it[name] || [])
          .flat()
        )
      )
    }
    addFrom('platforms')
    addFrom('tags')
    addFrom('nips')
  } else {
    window.availableTags = window.allTags
  }
}

function addToggle(name, cls) {
  const btn = document.createElement("div")
  btn.setAttribute("class", `tag ${name} ${cls}`)
  btn.setAttribute("onclick", `clickTag('${name}')`)
  btn.innerHTML = name
  toggles.append(btn)
}

function update() {
  updateAvailableTags()
  toggles.replaceChildren()
  window.activeTags.forEach(t => {
    addToggle(t, 'active')
  })
  window.availableTags.forEach(t => {
    if (window.activeTags.includes(t))
      return
    addToggle(t, 'available')
  })
  window.allTags.forEach(t => {
    if (window.activeTags.includes(t) || window.availableTags.includes(t))
      return
    addToggle(t, 'unavailable')
  })
  if (window.activeTags.length) {
    document.querySelectorAll('.result').forEach(it => it.style.display = 'none')
    document.querySelectorAll(`.result.${window.activeTags.join(".")}`).forEach(it => it.style.display = 'block')
  } else {
    document.querySelectorAll('.result').forEach(it => it.style.display = 'block')
  }
}
</script>

<link rel="stylesheet" href="{{ base_path }}/assets/css/nostrLinks.css" />
